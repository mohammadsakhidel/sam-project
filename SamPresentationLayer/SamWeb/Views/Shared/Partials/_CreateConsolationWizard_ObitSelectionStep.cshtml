@model CreateConsolationObitSelectionStepVM

<h2 class="step-title">
    @Strings.CreateConsolationObitSelectionStep
</h2>

<hr />

@using (Ajax.BeginForm("Create_ObitSelectionStep", "Consolations", null,
                                                                new AjaxOptions { UpdateTargetId = "wizard_step", LoadingElementId = "loading", OnBegin = "onBegin" },
                                                                new { @id = "frm_obit" }))
{
    @Html.AntiForgeryToken()

    <div class="form-group">
        <label for="ProvinceID" class="control-label">@Strings.Province</label>
        <div>
            <select name="ProvinceID" id="ProvinceID" class="form-control">
                <option value=""></option>
                @foreach (var p in SamUtils.Utils.CityUtil.Provinces)
                {
                    <option value="@p.ID" @(Model.ProvinceID.HasValue && p.ID == Model.ProvinceID.Value ? Html.Raw("selected=\"selected\"") : Html.Raw(""))>@p.Name</option>
                }
            </select>
        </div>
    </div>

    <div class="form-group">
        <label for="CityID" class="control-label">@Strings.City</label>
        <div>
            <select name="CityID" id="CityID" class="form-control">
                @if (Model.Cities != null && Model.Cities.Any())
                {
                    <option value=""></option>
                    foreach (var c in Model.Cities)
                    {
                        <option value="@c.ID" @(Model.CityID.HasValue && c.ID == Model.CityID.Value ? Html.Raw("selected=\"selected\"") : Html.Raw(""))>@c.Name</option>
                    }
                }
            </select>
        </div>
    </div>

    <div class="form-group">
        <label for="MosqueID" class="control-label">@Strings.Mosque</label>
        <div>
            <select name="MosqueID" id="MosqueID" class="form-control">
                @if (Model.Mosques != null && Model.Mosques.Any())
                {
                    <option value=""></option>
                    foreach (var m in Model.Mosques)
                    {
                        <option value="@m.ID" @(Model.MosqueID.HasValue && m.ID == Model.MosqueID.Value ? Html.Raw("selected=\"selected\"") : Html.Raw(""))>@m.Name</option>
                    }
                }
            </select>
        </div>
    </div>

    <div class="form-group">
        <label for="ObitID" class="control-label">@Strings.Obit</label>
        <div>
            <select name="ObitID" id="ObitID" class="form-control">
                @if (Model.Obits != null && Model.Obits.Any())
                {
                    <option value=""></option>
                    foreach (var o in Model.Obits)
                    {
                        <option value="@o.ID" @(Model.ObitID.HasValue && o.ID == Model.ObitID.Value ? Html.Raw("selected=\"selected\"") : Html.Raw(""))>@o.Title</option>
                    }
                }
            </select>
        </div>
    </div>

    <div class="form-group">
        <button type="submit" class="btn btn-success">
            <span class="glyphicon glyphicon-ok"></span>
            @Strings.ConfirmAndContinue
        </button>
    </div>

    <div class="text-danger">
        @Html.ValidationSummary()
    </div>
}

<script>

    $('#ProvinceID').change(function () {
        $('#CityID').prop('disabled', true);
        var provinceId = $(this).val();
        $.ajax({
            url: '/home/getprovincecities/' + provinceId,
            type: 'GET',
            success: onProvChangeSuccess,
            error: onAjaxError
        });
    });

    $('#CityID').change(function () {
        $('#MosqueID').prop('disabled', true);
        var cityId = $(this).val();
        $.ajax({
            url: '/consolations/getcitymosques/' + cityId,
            type: 'GET',
            success: onCityChangeSuccess,
            error: onAjaxError
        });
    });

    $('#MosqueID').change(function () {
        $('#ObitID').prop('disabled', true);
        var mosqueId = $(this).val();
        $.ajax({
            url: '/consolations/getallobits?mosqueId=' + mosqueId,
            type: 'GET',
            success: onMosqueChangeSuccess,
            error: onAjaxError
        });
    });

    function onProvChangeSuccess(data) {
        try {
            $('#CityID').html('<option></option>');
            $.each(data, function (key, val) {
                $('#CityID').append('<option value="' + val.ID + '">' + val.Name + '</option>');
            });
            $('#CityID').prop('disabled', false);
        } catch (e) {
            alert(e.message);
        }
    }

    function onCityChangeSuccess(data) {
        try {
            $('#MosqueID').html('<option></option>');
            $.each(data, function (key, val) {
                $('#MosqueID').append('<option value="' + val.ID + '">' + val.Name + ': ' + val.Address + '</option>');
            });
            $('#MosqueID').prop('disabled', false);
        } catch (e) {
            alert(e.message);
        }
    }

    function onMosqueChangeSuccess(data) {
        try {
            $('#ObitID').html('<option></option>');
            $.each(data, function (key, val) {
                $('#ObitID').append('<option value="' + val.ID + '">' + val.Title + ' : ' + val.ObitTypeDisplay + '</option>');
            });
            $('#ObitID').prop('disabled', false);
        } catch (e) {
            alert(e.message);
        }
    }

    function onAjaxError(data) {
        alert('@Messages.SomthingWrongHappend');
    }

</script>